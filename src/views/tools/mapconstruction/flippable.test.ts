import IndividualMapConstructor from "./individual_map_constructor";
import * as stream from "stream";
import * as fs from "fs";

test("transform card (Nissa)", async (done) => {
  const c = new IndividualMapConstructor(
    await new Promise((resolve) => {
      fs.readFile("./mapfiles/twofacedCards.json", {}, (_err, data) => {
        resolve(data.toString());
      });
    })
  );
  const s = new stream.Readable();
  await c.attachStream(s);
  // eslint-disable-next-line max-len, quotes
  const card = `{"object":"card","id":"008b1ea5-1a8d-4a9d-b208-421fea2f9c58","oracle_id":"35754a21-9fba-4370-a254-292918a777ba","multiverse_ids":[],"tcgplayer_id":101351,"cardmarket_id":283716,"name":"Nissa, Vastwood Seer // Nissa, Sage Animist","lang":"en","released_at":"2015-07-09","uri":"https://api.scryfall.com/cards/008b1ea5-1a8d-4a9d-b208-421fea2f9c58","scryfall_uri":"https://scryfall.com/card/ps15/189/nissa-vastwood-seer-nissa-sage-animist?utm_source=api","layout":"transform","highres_image":true,"image_status":"highres_scan","cmc":3.0,"type_line":"Legendary Creature — Elf Scout // Legendary Planeswalker — Nissa","color_identity":["G"],"keywords":[],"card_faces":[{"object":"card_face","name":"Nissa, Vastwood Seer","mana_cost":"{2}{G}","type_line":"Legendary Creature — Elf Scout","oracle_text":"When Nissa, Vastwood Seer enters the battlefield, you may search your library for a basic Forest card, reveal it, put it into your hand, then shuffle.Whenever a land enters the battlefield under your control, if you control seven or more lands, exile Nissa, then return her to the battlefield transformed under her owner's control.","colors":["G"],"power":"2","toughness":"2","artist":"Wayne Reynolds","artist_id":"afc47cec-3ccc-404e-a8c6-4d83dd504271","illustration_id":"21c1ad90-bab9-4cc6-b68e-94621f12af67","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.png?1582053404","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404"}},{"object":"card_face","name":"Nissa, Sage Animist","mana_cost":"","type_line":"Legendary Planeswalker — Nissa","oracle_text":"+1: Reveal the top card of your library. If it's a land card, put it onto the battlefield. Otherwise, put it into your hand.−2: Create Ashaya, the Awoken World, a legendary 4/4 green Elemental creature token.−7: Untap up to six target lands. They become 6/6 Elemental creatures. They're still lands.","colors":["G"],"color_indicator":["G"],"loyalty":"3","artist":"Wayne Reynolds","artist_id":"afc47cec-3ccc-404e-a8c6-4d83dd504271","illustration_id":"c7cc49cc-8041-4e26-aea7-8f58d83a0104","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","large":"https://c1.scryfall.com/file/scryfall-cards/large/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","png":"https://c1.scryfall.com/file/scryfall-cards/png/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.png?1582053404","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404"}}],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"legal","modern":"legal","legacy":"legal","pauper":"not_legal","vintage":"legal","penny":"not_legal","commander":"legal","brawl":"not_legal","historicbrawl":"not_legal","paupercommander":"not_legal","duel":"legal","oldschool":"not_legal","premodern":"not_legal"},"games":["paper"],"reserved":false,"foil":true,"nonfoil":false,"oversized":false,"promo":true,"reprint":true,"variation":false,"set_id":"a7525618-105f-4f97-98c9-0ed1522d4a8d","set":"ps15","set_name":"San Diego Comic-Con 2015","set_type":"promo","set_uri":"https://api.scryfall.com/sets/a7525618-105f-4f97-98c9-0ed1522d4a8d","set_search_uri":"https://api.scryfall.com/cards/search?order=set&q=e%3Aps15&unique=prints","scryfall_set_uri":"https://scryfall.com/sets/ps15?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/008b1ea5-1a8d-4a9d-b208-421fea2f9c58/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released&q=oracleid%3A35754a21-9fba-4370-a254-292918a777ba&unique=prints","collector_number":"189","digital":false,"rarity":"mythic","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7"}`;
  s.push(card);
  s.push(null);
  setTimeout(() => {
    const front_id = "008b1ea5-1a8d-4a9d-b208-421fea2f9c58";
    const back_id = "c7cc49cc-8041-4e26-aea7-8f58d83a0104";
    expect(c.mapTemplate!.mapData[0][back_id]).toBe(
      "https://c1.scryfall.com/file/scryfall-cards/large/back/0/0/008b1ea5-1a8d-4a9d-b208-421fea2f9c58.jpg?1582053404"
    );
    expect(c.mapTemplate!.mapData[1][front_id]).toBe(back_id);
    expect(c.mapTemplate!.mapData[2][front_id]).toBe("highres_scan");
    done();
  }, 0);
});

test("non matching card", async (done) => {
  const c = new IndividualMapConstructor(
    await new Promise((resolve) => {
      fs.readFile("./mapfiles/twofacedCards.json", {}, (_err, data) => {
        resolve(data.toString());
      });
    })
  );
  const s = new stream.Readable();
  await c.attachStream(s);
  // eslint-disable-next-line max-len, quotes
  const card = `{"object":"card","id":"002ad179-ddf4-4f48-9504-cfa02e11a52e","oracle_id":"a755add5-04ec-4e37-9eb6-152d52cfa46d","multiverse_ids":[],"name":"Clearwater Pathway // Clearwater Pathway","lang":"en","released_at":"2020-09-25","uri":"https://api.scryfall.com/cards/002ad179-ddf4-4f48-9504-cfa02e11a52e","scryfall_uri":"https://scryfall.com/card/aznr/25/clearwater-pathway-clearwater-pathway?utm_source=api","layout":"art_series","highres_image":false,"image_status":"lowres","cmc":0.0,"type_line":"Card // Card","color_identity":[],"keywords":[],"card_faces":[{"object":"card_face","name":"Clearwater Pathway","mana_cost":"","type_line":"Card","oracle_text":"","colors":[],"artist":"Johannes Voss","artist_id":"3593dd7e-c547-4a32-81cd-7da725f60118","illustration_id":"3be0e68b-1bd6-4941-8605-503290443a04","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.png?1600982859","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859"}},{"object":"card_face","name":"Clearwater Pathway","mana_cost":"","type_line":"Card","oracle_text":"","colors":[],"artist":"Johannes Voss","artist_id":"3593dd7e-c547-4a32-81cd-7da725f60118","illustration_id":"09ad330a-17c5-4c28-a97a-de0562ba2fd8","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","large":"https://c1.scryfall.com/file/scryfall-cards/large/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","png":"https://c1.scryfall.com/file/scryfall-cards/png/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.png?1600982859","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/back/0/0/002ad179-ddf4-4f48-9504-cfa02e11a52e.jpg?1600982859"}}],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"not_legal","modern":"not_legal","legacy":"not_legal","pauper":"not_legal","vintage":"not_legal","penny":"not_legal","commander":"not_legal","brawl":"not_legal","historicbrawl":"not_legal","paupercommander":"not_legal","duel":"not_legal","oldschool":"not_legal","premodern":"not_legal"},"games":[],"reserved":false,"foil":true,"nonfoil":true,"oversized":false,"promo":false,"reprint":true,"variation":false,"set_id":"168acc08-0dea-40e7-ab0d-93bb2832e72b","set":"aznr","set_name":"Zendikar Rising Art Series","set_type":"memorabilia","set_uri":"https://api.scryfall.com/sets/168acc08-0dea-40e7-ab0d-93bb2832e72b","set_search_uri":"https://api.scryfall.com/cards/search?order=set&q=e%3Aaznr&unique=prints","scryfall_set_uri":"https://scryfall.com/sets/aznr?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/002ad179-ddf4-4f48-9504-cfa02e11a52e/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released&q=oracleid%3Aa755add5-04ec-4e37-9eb6-152d52cfa46d&unique=prints","collector_number":"25","digital":false,"rarity":"common","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7"}`;
  s.push(card);
  s.push(null);
  const id = "002ad179-ddf4-4f48-9504-cfa02e11a52e";
  expect(c.mapTemplate!.mapData[0][id]).toBeUndefined();
  done();
});

test("transform card (Jorn)", async (done) => {
  const c = new IndividualMapConstructor(
    await new Promise((resolve) => {
      fs.readFile("./mapfiles/twofacedCards.json", {}, (_err, data) => {
        resolve(data.toString());
      });
    })
  );
  const s = new stream.Readable();
  await c.attachStream(s);
  // eslint-disable-next-line max-len, quotes
  const card = `{"object":"card","id":"c697548f-925b-405e-970a-4e78067d5c8e","oracle_id":"bd43b485-e42e-4c20-adcb-799b0ce18a59","multiverse_ids":[503794,503793],"mtgo_id":87699,"arena_id":75224,"tcgplayer_id":230218,"cardmarket_id":530702,"name":"Jorn, God of Winter // Kaldring, the Rimestaff","lang":"en","released_at":"2021-02-05","uri":"https://api.scryfall.com/cards/c697548f-925b-405e-970a-4e78067d5c8e","scryfall_uri":"https://scryfall.com/card/khm/179/jorn-god-of-winter-kaldring-the-rimestaff?utm_source=api","layout":"modal_dfc","highres_image":true,"image_status":"highres_scan","cmc":3.0,"type_line":"Legendary Snow Creature — God // Legendary Snow Artifact","color_identity":["B","G","U"],"keywords":[],"card_faces":[{"object":"card_face","name":"Jorn, God of Winter","mana_cost":"{2}{G}","type_line":"Legendary Snow Creature — God","oracle_text":"Whenever Jorn attacks, untap each snow permanent you control.","colors":["G"],"power":"3","toughness":"3","flavor_text":"Wherever snow falls, I am home.","artist":"Magali Villeneuve","artist_id":"9e6a55ae-be4d-4c23-a2a5-135737ffd879","illustration_id":"8fba6022-6daf-487b-bdab-7bccd482609d","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","large":"https://c1.scryfall.com/file/scryfall-cards/large/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","png":"https://c1.scryfall.com/file/scryfall-cards/png/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.png?1623022377","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/front/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377"}},{"object":"card_face","name":"Kaldring, the Rimestaff","mana_cost":"{1}{U}{B}","type_line":"Legendary Snow Artifact","oracle_text":"{T}: You may play target snow permanent card from your graveyard this turn. If you do, it enters the battlefield tapped.","colors":["B","U"],"flavor_text":"As the sagas tell it, Jorn collects a sliver of ice from every realm he visits.","artist":"Magali Villeneuve","artist_id":"9e6a55ae-be4d-4c23-a2a5-135737ffd879","illustration_id":"df10ea65-fffd-4d95-9e79-f9f653000e42","image_uris":{"small":"https://c1.scryfall.com/file/scryfall-cards/small/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","normal":"https://c1.scryfall.com/file/scryfall-cards/normal/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","large":"https://c1.scryfall.com/file/scryfall-cards/large/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","png":"https://c1.scryfall.com/file/scryfall-cards/png/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.png?1623022377","art_crop":"https://c1.scryfall.com/file/scryfall-cards/art_crop/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377","border_crop":"https://c1.scryfall.com/file/scryfall-cards/border_crop/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377"}}],"legalities":{"standard":"legal","future":"legal","historic":"legal","gladiator":"legal","pioneer":"legal","modern":"legal","legacy":"legal","pauper":"not_legal","vintage":"legal","penny":"not_legal","commander":"legal","brawl":"legal","historicbrawl":"legal","paupercommander":"not_legal","duel":"legal","oldschool":"not_legal","premodern":"not_legal"},"games":["arena","paper","mtgo"],"reserved":false,"foil":true,"nonfoil":true,"oversized":false,"promo":false,"reprint":false,"variation":false,"set_id":"43057fad-b1c1-437f-bc48-0045bce6d8c9","set":"khm","set_name":"Kaldheim","set_type":"expansion","set_uri":"https://api.scryfall.com/sets/43057fad-b1c1-437f-bc48-0045bce6d8c9","set_search_uri":"https://api.scryfall.com/cards/search?order=set&q=e%3Akhm&unique=prints","scryfall_set_uri":"https://scryfall.com/sets/khm?utm_source=api","rulings_uri":"https://api.scryfall.com/cards/c697548f-925b-405e-970a-4e78067d5c8e/rulings","prints_search_uri":"https://api.scryfall.com/cards/search?order=released&q=oracleid%3Abd43b485-e42e-4c20-adcb-799b0ce18a59&unique=prints","collector_number":"179","digital":false,"rarity":"rare","card_back_id":"0aeebaf5-8c7d-4636-9e82-8c27447861f7"}`;
  s.push(card);
  s.push(null);
  setTimeout(() => {
    const front_id = "c697548f-925b-405e-970a-4e78067d5c8e";
    const back_id = "df10ea65-fffd-4d95-9e79-f9f653000e42";
    expect(c.mapTemplate!.mapData[0][back_id]).toBe(
      "https://c1.scryfall.com/file/scryfall-cards/large/back/c/6/c697548f-925b-405e-970a-4e78067d5c8e.jpg?1623022377"
    );
    expect(c.mapTemplate!.mapData[1][front_id]).toBe(back_id);
    expect(c.mapTemplate!.mapData[2][front_id]).toBe("highres_scan");
    done();
  }, 0);
});
